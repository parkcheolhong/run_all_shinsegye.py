from modules.sorisay_core_controller import SorisayCore
from modules.sorisay_dashboard_web import run_dashboard
import threading
import time
import os
from datetime import datetime

LOG_DIR = "logs"
LOG_FILE = os.path.join(LOG_DIR, "voice_history.txt")

# ë¡œê·¸ í´ë” ìƒì„±
os.makedirs(LOG_DIR, exist_ok=True)

def log_voice_command(text):
    """ìŒì„± ëª…ë ¹ì„ ë¡œê·¸ì— ê¸°ë¡"""
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        f.write(f"[{timestamp}] {text}\n")

def main():
    print("ğŸš€ ì‹ ì„¸ê³„ í†µí•© í”„ë¡œì íŠ¸ ì‹¤í–‰ ì¤‘...")

    # ëŒ€ì‹œë³´ë“œ ì›¹ ì„œë²„ ìŠ¤ë ˆë“œ ì‹œì‘
    threading.Thread(target=run_dashboard, daemon=True).start()
    time.sleep(1)

    # ì†Œë¦¬ìƒˆ ì—”ì§„ êµ¬ë™
    sorisay = SorisayCore()

    try:
        for text in sorisay.run():  # run() í•¨ìˆ˜ì—ì„œ yieldë¡œ ìŒì„± í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ê²Œ ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
            print(f"[ì‚¬ìš©ì ëª…ë ¹]: {text}")
            log_voice_command(text)  # ë¡œê·¸ ì €ì¥
            if "ë" in text:
                sorisay.speak("ì†Œë¦¬ìƒˆë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                break
    except KeyboardInterrupt:
        print("ğŸ§¹ ì‚¬ìš©ìê°€ ìˆ˜ë™ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.")
    finally:
        print("ğŸ›‘ ì‹œìŠ¤í…œ ì¢…ë£Œ ì™„ë£Œ")
        log_voice_command("=== ì„¸ì…˜ ì¢…ë£Œ ===")

if __name__ == "__main__":
    main()
