import os, subprocess, datetime, json, shutil

# === ShinsegyeBox ìë™ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ === #
# by ì†Œë¦¬ìƒˆ & íŒŒíŠ¸ë„ˆ

PROJECT = "ShinsegyeBox"
REPO_URL = "https://github.com/parkcheolhong/ShinsegyeBox"
ROOT = os.path.abspath(os.path.dirname(__file__))

# ì•ˆì „í•œ í´ë” ìƒì„±
for folder in ["logs", "backup"]:
    os.makedirs(os.path.join(ROOT, folder), exist_ok=True)

# 1. ì‹¤í–‰ ìˆœì„œ í‘œì‹œ
print(f"\nğŸŒ€ [{datetime.datetime.now().strftime('%H:%M:%S')}] ì‹ ì„¸ê³„ ë°•ìŠ¤ ìë™ ë£¨í”„ ì‹œì‘\n")

# 2. í•™ìŠµ/ì¡°ì • ëª¨ë“ˆ ì‹¤í–‰
for script in ["ai_self_evolve_demo.py", "ai_self_evolve_config_demo.py"]:
    path = os.path.join(ROOT, script)
    if os.path.exists(path):
        print(f"â–¶ ì‹¤í–‰ ì¤‘: {script}")
        subprocess.run(["python", path], check=False)
    else:
        print(f"âš ï¸ {script} íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

# 3. ìë™ ë°±ì—…
cfg = os.path.join(ROOT, "system_config.json")
if os.path.exists(cfg):
    backup_name = f"system_config_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    shutil.copy(cfg, os.path.join(ROOT, "backup", backup_name))
    print(f"ğŸ’¾ ì„¤ì • ë°±ì—… ì™„ë£Œ: {backup_name}")

# 4. GitHub ì—…ë¡œë“œ
print("\nğŸš€ GitHub ìë™ í‘¸ì‹œ ì‹œì‘...")
try:
    subprocess.run(["git", "add", "."], check=True)
    subprocess.run(["git", "commit", "-m", f"Auto update from ShinsegyeBox at {datetime.datetime.now()}"], check=False)
    subprocess.run(["git", "push", "origin", "main"], check=True)
    print("âœ… GitHub ì—…ë¡œë“œ ì™„ë£Œ.")
except Exception as e:
    print("âš ï¸ GitHub í‘¸ì‹œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e)

print("\nğŸŒˆ ëª¨ë“  ì‘ì—… ì™„ë£Œ! ì‹ ì„¸ê³„ ë°•ìŠ¤ê°€ ìë™ìœ¼ë¡œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n")
# === ìë™ ë¦¬í¬íŠ¸ ìƒì„± ë° README ê°±ì‹  === #
report_path = os.path.join(ROOT, "README.md")
log_dir = os.path.join(ROOT, "logs")

# ìµœê·¼ ë¡œê·¸ íŒŒì¼ ì°¾ê¸°
latest_log = None
if os.path.exists(log_dir):
    logs = [os.path.join(log_dir, f) for f in os.listdir(log_dir)]
    if logs:
        latest_log = max(logs, key=os.path.getctime)

timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

report = [
    "# ShinsegyeBox ìë™ ë¦¬í¬íŠ¸",
    "",
    f"ğŸ•’ {timestamp}",
    "- í•™ìŠµ/ì¡°ì • ë£¨í”„ ì™„ë£Œ",
    "- ì„¤ì • ë°±ì—… ë° GitHub ë™ê¸°í™” ì™„ë£Œ âœ…"
]

if latest_log:
    report.append(f"- ìµœê·¼ ë¡œê·¸ íŒŒì¼: `{os.path.basename(latest_log)}`")

# README ê°±ì‹ 
with open(report_path, "w", encoding="utf-8") as f:
    f.write("\n".join(report))

print("ğŸª¶ ìë™ ë¦¬í¬íŠ¸ ì‘ì„± ì™„ë£Œ!")

# GitHub ë°˜ì˜
try:
    subprocess.run(["git", "add", "README.md"], check=True)
    subprocess.run(["git", "commit", "-m", f"Auto report update from ShinsegyeBox at {timestamp}"], check=False)
    subprocess.run(["git", "push", "origin", "main"], check=True)
    print("âœ… GitHub README ìë™ ì—…ë¡œë“œ ì™„ë£Œ!")
except Exception as e:
    print("âš ï¸ README ìë™ í‘¸ì‹œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e)
